<!DOCTYPE html>
<html>
  <head>
    <title>Lightbox JSON API</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <style type='text/css'>
    html, body {
      font-family: Arial, sans-serif;
    }
    ul, ol {
      margin: 0;
      padding: 0;
    }
    .output {
      position: relative;
      float: left;
      width: 195px;
      height: 190px;
      margin-right: 20px;
      padding: 5px;
      border: 2px solid #777;
      border-radius: 10px;
      overflow: auto;
    }
    .output strong {
      margin-left: 20px;
    }
    .output .mixed {
      position: absolute;
      right: 10px;
      bottom: 10px;
      width: 45px;
      height: 159px;
      border: 1px solid #000;
    }
    .ouptut .wrapper {
      position: relative;
      overflow: auto;
    }
    .output .layers {
      position: absolute;
      bottom: 10px;
      left: 5px;
      width: 133px;
      list-style: none;
    }
    .output .layer {
      margin-top: 10px;
      overflow: auto;
    }
    .output .layer .color {
      float: right;
      width: 45px;
      height: 45px;
      border: 1px solid #000;
    }
    .output .layer ul {
      margin-top: 4px;
      list-style: none;
      font-size: 10px;
    }
    </style>
  </head>
  <body>
    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script>
      $(document).ready(function() {
        $.getJSON('/api', getLights);
      });

      function getLights(json) {
        var preview = $('#preview'),
            struct = $('.output').detach();

        // Get the number of lights
        for(var output = 0; output < json.outputs; output++) {
          showLight(struct, preview, output);
        }
      }

      function showLight(struct, preview, output) {
        // Add div for the light
        var node = struct.clone();
        node.find('strong').text('Output ' + output);
        preview.append(node);

        // Update periodically
        setInterval(function () {
          $.getJSON('/api/output?id=' + output, updateColors(node));
        }, 100);
      }

      function updateColors(node) {
        return function(json) {
          node.find('.mixed').css('background-color', json.mixedColorHex);
          node.find('.layer').each(updateLayerInfo(json));
        }
      }

      function updateLayerInfo(output) {
        return function(listIndex) {
          var layerData = output.layers[output.layerCount - 1 - listIndex];
          var layer = $(this);
          layer.find('.color').css('background-color', layerData.colorHex);
          layer.find('.blender').text(layerData.blender);
          layer.find('.envelope').text(layerData.envelope);
          layer.find('.opacity').text(Math.round(layerData.opacity * 100));
        }
      }
    </script>
    <h1>Lightbox JSON API</h1>
    <p>Lightbox was originally developed for the <a href="http://twitterboom.nl">Twitterboom</a>, which was demonstrated to the public during the Christmas season of 2011 in the public library of Leeuwarden, the hometown of <a href="http://frack.nl/wiki/">Frack</a>.</p>
    <p>All code and documentation is <a href="https://github.com/frack/Lightbox">available on GitHub</a>.</p>
    <h2>Send API commands</h2>
    <p>API commands can be one object that describes a transition for a single output+layer, or an array of these.</p>
    <p>Multiple transitions for a single output will be executed in series, multiple transitions for different outputs will be excecuted in unison.</p>
    <form method="post">
      <textarea name="json" cols="80" rows="20">%s</textarea>
      <br>
      <input type="submit" value="push!" />
    </form>
    <h2>API Information</h2>
    <ul>
      <li>API commands should be sent to <code>/api</code> (HTTP POST, argument <code>json</code>);</li>
      <li>Controller information can be retrieved from <a href="/api"><code>/api</code></a>;</li>
      <li>Output information (mixed and layer colors, opacity etc) can be retrieved from <a href="/api/output?id=0"><code>/api/output?id=OUTPUT_ID</code></a>.</li>
    </ul>
    <h2>Current strip colors</h2>
    <p>Basic jQuery/JavaScript retrieval for the current colors on the strip.</p>
    <div id="preview">
      <div class="output">
        <strong>Output 42</strong>
        <div class="mixed"></div>
        <ol class="layers">
          <li class="layer">
            <div class="color"></div>
            <ul>
              <li>Opacity: <span class="opacity"></span>%%</li>
              <li class="blender"></li>
              <li class="envelope"></li>
            </ul>
          </li>
          <li class="layer">
            <div class="color"></div>
            <ul>
              <li>Opacity: <span class="opacity"></span>%%</li>
              <li class="blender"></li>
              <li class="envelope"></li>
            </ul>
          </li>
          <li class="layer">
            <div class="color"></div>
            <ul>
              <li>Opacity: <span class="opacity"></span>%%</li>
              <li class="blender"></li>
              <li class="envelope"></li>
            </ul>
          </li>
        </ol>
      </div>
    </div>
    <br clear="both">
  </body>
</html>
